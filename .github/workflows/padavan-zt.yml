name: Padavan-ZeroTier Builder (Final Fix)

on:
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  DEVICE: K2P
  PADAVAN_REPO: https://github.com/hanwckf/padavan-4.4
  ZEROTIER_REPO: https://github.com/zerotier/ZeroTierOne

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 150

    steps:
    # ========== 初始化环境 ==========
    - name: Setup environment
      run: |
        echo "BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        sudo apt-get -qq update
        sudo DEBIAN_FRONTEND=noninteractive apt-get -qq install \
            unzip libtool-bin curl cmake gperf gawk flex bison nano xxd \
            fakeroot kmod cpio git python3-docutils gettext automake autopoint \
            texinfo build-essential help2man pkg-config zlib1g-dev libgmp3-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget

    # ========== 克隆仓库 ==========
    - name: Clone repositories
      run: |
        git clone --depth=1 --branch=main --recurse-submodules=trunk $PADAVAN_REPO padavan-4.4
        cd padavan-4.4
        git submodule update --init --recursive trunk
        echo "PADAVAN_DIR=$GITHUB_WORKSPACE/padavan-4.4" >> $GITHUB_ENV

        git clone --depth=1 $ZEROTIER_REPO ZeroTierSource
        echo "ZEROTIER_SRC=$GITHUB_WORKSPACE/ZeroTierSource" >> $GITHUB_ENV

    # ========== 工具链配置 ==========
    - name: Setup toolchain
      timeout-minutes: 30
      run: |
        cd $PADAVAN_DIR/toolchain-mipsel
        
        # 多镜像源下载
        mirrors=(
          "https://ghproxy.com/https://github.com/hanwckf/padavan-4.4/releases/download/toolchain/toolchain-4.4.x.tar.gz"
          "https://hub.yzuu.cf/hanwckf/padavan-4.4/releases/download/toolchain/toolchain-4.4.x.tar.gz"
          "https://github.com/hanwckf/padavan-4.4/releases/download/toolchain/toolchain-4.4.x.tar.gz"
        )
        
        for mirror in "${mirrors[@]}"; do
          if wget -q --show-progress -O toolchain.tar.gz "$mirror"; then
            echo "下载成功: $mirror"
            tar -zxvf toolchain.tar.gz
            rm toolchain.tar.gz
            break
          else
            echo "镜像失效: $mirror"
            rm -rf toolchain-4.4.x
          fi
        done
        
        echo "$PADAVAN_DIR/toolchain-mipsel/toolchain-4.4.x/bin" >> $GITHUB_PATH

    # ========== 配置阶段（关键修复） ==========
    - name: Configure system
      run: |
        cd $PADAVAN_DIR/trunk
        
        # 初始化配置目录
        mkdir -p configs/templates
        [ -f configs/templates/$DEVICE.config ] || touch configs/templates/$DEVICE.config
        
        # 动态配置注入
        declare -A config_map=(
          ["ZEROTIER"]="y"
          ["OPENSSL_EXE"]="y"
          ["JQ"]="y"
        )
        
        # 使用awk处理模板文件
        awk -v dev="$DEVICE" '
          BEGIN { changed=0 }
          /^CONFIG_FIRMWARE_INCLUDE_ZEROTIER=/ { $0="CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y"; changed=1 }
          /^CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=/ { $0="CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y"; changed=1 }
          /^CONFIG_FIRMWARE_INCLUDE_JQ=/ { $0="CONFIG_FIRMWARE_INCLUDE_JQ=y"; changed=1 }
          { print }
          END {
            if (!changed) {
              print "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y"
              print "CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y"
              print "CONFIG_FIRMWARE_INCLUDE_JQ=y"
            }
          }
        ' configs/templates/$DEVICE.config > temp.config
        mv temp.config configs/templates/$DEVICE.config
        
        # 生成基础配置
        set +e  # 临时禁用错误退出
        fakeroot ./build_firmware_modify --dry-run $DEVICE
        if [ ! -f .config ]; then
          echo "::warning:: 使用备用配置生成方式"
          cp configs/templates/$DEVICE.config .config
          yes "" | make oldconfig
        fi
        set -e  # 重新启用错误退出
        
        # 强制配置验证
        grep -q "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y" .config || {
          echo "::error:: ZeroTier配置丢失，执行紧急修复"
          echo "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y" >> .config
          echo "CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y" >> .config
          echo "CONFIG_FIRMWARE_INCLUDE_JQ=y" >> .config
          yes "" | make oldconfig
        }

    # ...（后续步骤保持不变）...
