name: Padavan-ZeroTier Builder

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEVICE: K2P
      PADAVAN_REPO: https://github.com/hanwckf/padavan-4.4
      ZEROTIER_REPO: https://github.com/zerotier/ZeroTierOne

    steps:
    # ========== 初始化环境 ==========
    - name: Setup environment
      run: |
        echo "BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        sudo apt-get -qq update
        sudo apt-get -qq install $(curl -fsSL https://raw.githubusercontent.com/hanwckf/padavan-4.4/master/.github/workflows/build-padavan.yml | grep 'sudo apt' | sed 's/sudo apt-get //')

    # ========== 克隆仓库 ==========
    - name: Clone Padavan
      run: |
        git clone --depth=1 --branch=master --recurse-submodules $PADAVAN_REPO
        cd padavan-4.4
        git submodule update --init --recursive trunk
        echo "PADAVAN_DIR=$GITHUB_WORKSPACE/padavan-4.4" >> $GITHUB_ENV

    - name: Clone ZeroTier
      run: |
        git clone --depth=1 $ZEROTIER_REPO
        echo "ZEROTIER_SRC=$GITHUB_WORKSPACE/ZeroTierOne" >> $GITHUB_ENV

    # ========== 准备工具链 ==========
    - name: Setup toolchain
      timeout-minutes: 20
      run: |
        cd $PADAVAN_DIR/toolchain-mipsel
        [ -f "dl_toolchain.sh" ] || curl -O https://raw.githubusercontent.com/hanwckf/padavan-4.4/master/toolchain-mipsel/dl_toolchain.sh
        chmod +x dl_toolchain.sh
        ./dl_toolchain.sh
        echo "$PADAVAN_DIR/toolchain-mipsel/toolchain-4.4.x/bin" >> $GITHUB_PATH

    # ========== 集成ZeroTier ==========
    - name: Integrate ZeroTier
      run: |
        cd $PADAVAN_DIR/trunk
        mkdir -p user/zerotier
        cp -r $ZEROTIER_SRC/* user/zerotier/
        
        # 生成自动编译配置
        cat > user/zerotier/auto_install.mk <<'EOF'
        define Package/zerotier
          $(call Package/zerotier/Default)
          TITLE:=ZeroTier One (Auto Integrated)
          DEPENDS:=+libpthread +libstdcpp +kmod-tun +libopenssl +libjson-c
        endef
        EOF

    # ========== 配置系统 (关键修正) ==========
    - name: Configure system
      run: |
        cd $PADAVAN_DIR/trunk
        
        # 初始化配置系统
        ./scripts/feeds update -a
        ./scripts/feeds install -a
        
        # 生成基础配置
        cp configs/templates/$DEVICE.config .config
        sed -i '/CONFIG_FIRMWARE_INCLUDE_ZEROTIER/d' .config
        echo "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y" >> .config
        echo "CONFIG_FIRMWARE_INCLUDE_JQ=y" >> .config
        
        # 非交互式配置
        yes "" | make oldconfig
        
        # 最终验证
        [ -f ".config" ] || (echo "::error:: 配置文件仍未生成"; exit 1)
        grep -q "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y" .config || exit 1

    # ========== 编译固件 ==========
    - name: Build firmware
      timeout-minutes: 60
      run: |
        cd $PADAVAN_DIR/trunk
        make -j$(nproc) V=s
        
        mkdir -p $GITHUB_WORKSPACE/output
        cp images/*.trx $GITHUB_WORKSPACE/output/

    # ========== 上传产物 ==========
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}_ZT_${{ env.BUILD_TIMESTAMP }}
        path: $GITHUB_WORKSPACE/output/*.trx
