name: Padavan-ZeroTier-Build

on:
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  DEVICE: K2P
  BLOCK_SIZE: 15872
  ZT_REPO: https://github.com/zerotier/ZeroTierOne.git

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    # ========== 增强版工具链配置 ==========
    - name: Setup toolchain (enhanced)
      run: |
        cd padavan-src/toolchain-mipsel
        
        # 验证基础环境
        echo "当前工作目录: $(pwd)"
        ls -la
        
        # 多源下载配置
        TOOLCHAIN_URLS=(
          "https://github.com/hanwckf/padavan-4.4/releases/download/toolchain/mipsel-4.4.x.tar.xz"
          "https://mirror.example.com/toolchain/mipsel-4.4.x.tar.xz"
          "https://oss-attachment.cn-hangzhou.oss.aliyun-inc.com/toolchain/mipsel-4.4.x.tar.xz"
        )
        
        # 分片下载函数
        download_with_retry() {
          local url=$1
          local filename=$2
          for i in {1..5}; do
            if wget --tries=3 --timeout=30 -c "$url" -O "$filename"; then
              return 0
            fi
            sleep $((10 * i))
          done
          return 1
        }
        
        # 主下载逻辑
        success=false
        for url in "${TOOLCHAIN_URLS[@]}"; do
          echo "尝试从 $url 下载工具链..."
          filename="toolchain-$(date +%s).tar.xz"
          
          if download_with_retry "$url" "$filename"; then
            echo "下载成功，开始解压..."
            mkdir -p toolchain-4.4.x
            if tar -xJf "$filename" -C toolchain-4.4.x --strip-components=1; then
              success=true
              break
            else
              echo "解压失败，尝试下一个源..."
              rm -rf toolchain-4.4.x
            fi
          fi
        done
        
        if [ "$success" = false ]; then
          echo "::error::所有下载源均失败"
          exit 1
        fi
        
        # 验证工具链
        [ -f "toolchain-4.4.x/bin/mipsel-linux-uclibc-gcc" ] || {
          echo "::error::工具链验证失败"
          exit 1
        }
        
        echo "TOOLCHAIN_PATH=$(pwd)/toolchain-4.4.x/bin" >> $GITHUB_ENV
