name: Padavan-ZeroTier-Build

on:
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  DEVICE: K2P
  BLOCK_SIZE: 15872
  ZT_REPO: https://github.com/zerotier/ZeroTierOne.git

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    # ========== 仓库克隆与验证 ==========
    - name: Clone Padavan repository
      uses: actions/checkout@v4
      with:
        repository: hanwckf/padavan-4.4
        path: padavan-src
        ref: master  # 修正为实际分支名称
        fetch-depth: 0

    - name: Validate repository structure
      run: |
        echo "当前工作目录: $(pwd)"
        echo "仓库目录结构:"
        ls -la padavan-src/
        echo "工具链目录检查:"
        if [ -d "padavan-src/toolchain" ]; then
          echo "✅ 找到工具链目录"
          ls -la padavan-src/toolchain
        else
          echo "::error::❌ 工具链目录不存在"
          exit 1
        fi

    # ========== 工具链管理 ==========
    - name: Setup toolchain
      run: |
        cd padavan-src/toolchain
        
        # 增强权限检查
        if [ ! -f "scripts/dl_toolchain.sh" ]; then
          echo "::error::❌ 找不到工具链下载脚本"
          exit 1
        fi
        chmod +x scripts/dl_toolchain.sh
        
        # 动态架构参数处理
        case ${{ matrix.target }} in
          mipsel)
            ARCH="mipsel"
            ;;
          arm7l)
            ARCH="arm"
            ;;
        esac

        # 重试逻辑增强
        max_retries=5
        attempt=1
        while [ $attempt -le $max_retries ]; do
          echo "▶️ 第 $attempt 次尝试下载工具链 (共 $max_retries 次)"
          log_file="toolchain_$attempt.log"
          
          if ./scripts/dl_toolchain.sh $ARCH 2>&1 | tee "$log_file"; then
            if [ -d "toolchain-4.4.x/bin" ]; then
              echo "✅ 工具链下载成功"
              break
            fi
          fi
          
          sleep_time=$((30 + RANDOM % 30))
          echo "⚠️ 下载失败，等待 ${sleep_time} 秒后重试..."
          sleep $sleep_time
          ((attempt++))
        done

        if [ ! -d "toolchain-4.4.x/bin" ]; then
          echo "::error::❌ 所有下载尝试均失败"
          echo "=== 错误日志摘要 ==="
          grep -iE 'error|fail' toolchain_*.log
          exit 1
        fi
        
        echo "TOOLCHAIN_PATH=$(pwd)/toolchain-4.4.x/bin" >> $GITHUB_ENV

    # ========== 剩余步骤保持不变 ==========
    # ... [其他步骤配置] ...
