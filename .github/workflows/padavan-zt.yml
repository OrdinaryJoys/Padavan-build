jobs:
  build:
    steps:
    # ========== 仓库克隆优化 ==========
    - name: Clone Padavan base
      uses: actions/checkout@v4
      with:
        repository: hanwckf/padavan-4.4
        path: padavan-src  # 修改存储路径避免冲突
        ref: main
        fetch-depth: 0
        retries: 3

    # ========== 新增路径验证步骤 ==========
    - name: Validate directory structure
      run: |
        echo "当前工作目录: $(pwd)"
        echo "目录结构:"
        ls -la
        echo "Padavan源码目录:"
        ls -la padavan-src/
        
        [ -d "padavan-src/toolchain" ] || {
          echo "::error::关键目录缺失: padavan-src/toolchain 不存在"
          exit 1
        }

    # ========== 修正后的工具链步骤 ==========
    - name: Setup toolchain
      if: steps.toolchain-cache.outputs.cache-hit != 'true'
      run: |
        cd padavan-src/toolchain  # 修正路径
        echo "当前工具链目录: $(pwd)"
        
        # 添加权限验证
        [ -x "scripts/dl_toolchain.sh" ] || {
          echo "::error::dl_toolchain.sh 缺少执行权限"
          chmod +x scripts/dl_toolchain.sh || exit 1
        }
        
        # 增强版下载逻辑
        max_retries=5
        success=false
        
        for ((i=1; i<=max_retries; i++)); do
          echo "▶️ 第 $i 次尝试下载工具链 (剩余重试次数: $((max_retries - i)))"
          log_file="toolchain_attempt_${i}.log"
          
          if ./scripts/dl_toolchain.sh mipsel 2>&1 | tee "$log_file"; then
            if [ -d "toolchain-4.4.x/bin" ]; then
              success=true
              echo "✅ 工具链下载验证通过"
              break
            else
              echo "⚠️ 脚本执行成功但目录未生成，检查日志: $log_file"
            fi
          else
            echo "⚠️ 下载失败，等待随机时间后重试..."
            sleep $((20 + RANDOM % 40))
          fi
        done

        if [ "$success" = false ]; then
          echo "::error::❌ 所有下载尝试均失败！"
          echo "=== 最后日志摘要 ==="
          tail -n 100 toolchain_attempt_*.log
          exit 1
        fi
        
        echo "TOOLCHAIN_PATH=$(pwd)/toolchain-4.4.x/bin" >> $GITHUB_ENV
