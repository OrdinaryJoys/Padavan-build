name: Padavan-ZeroTier Builder

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEVICE: K2P
      PADAVAN_REPO: https://github.com/hanwckf/padavan-4.4
      ZEROTIER_REPO: https://github.com/zerotier/ZeroTierOne

    steps:
    # ========== 初始化环境 ==========
    - name: Setup environment
      run: |
        echo "BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV

    # ========== 克隆基础仓库 ==========
    - name: Clone Padavan (完整克隆)
      run: |
        git clone --depth=1 --branch=chinese $PADAVAN_REPO
        cd padavan-4.4
        git submodule update --init --recursive
        echo "PADAVAN_DIR=$GITHUB_WORKSPACE/padavan-4.4" >> $GITHUB_ENV

    - name: Clone ZeroTier
      run: |
        git clone --depth=1 $ZEROTIER_REPO
        echo "ZEROTIER_SRC=$GITHUB_WORKSPACE/ZeroTierOne" >> $GITHUB_ENV

    # ========== 验证仓库结构 ==========
    - name: Validate repository structure
      run: |
        echo "=== Padavan目录结构 ==="
        ls -l $PADAVAN_DIR/trunk/scripts
        
        echo "=== 关键文件检查 ==="
        [ -f "$PADAVAN_DIR/trunk/scripts/feeds" ] || exit 1
        [ -d "$PADAVAN_DIR/trunk/user" ] || exit 1

    # ========== 准备工具链 ==========
    - name: Setup toolchain
      run: |
        cd $PADAVAN_DIR/trunk
        ./tools/download_toolchain.sh

    # ========== 配置编译系统 ==========
    - name: Configure system
      run: |
        cd $PADAVAN_DIR/trunk
        make prepare
        
        # 安装必要依赖
        ./scripts/install.sh

    # ========== 集成ZeroTier ==========
    - name: Integrate ZeroTier
      run: |
        cd $PADAVAN_DIR/trunk
        mkdir -p user/zerotier
        cp -r $ZEROTIER_SRC/* user/zerotier/
        
        # 创建符号链接到编译系统
        ln -sf $(pwd)/user/zerotier package/zerotier

    # ========== 配置设备选项 ==========
    - name: Configure device
      run: |
        cd $PADAVAN_DIR/trunk
        ./configure $DEVICE
        
        # 激活自定义选项
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_ZEROTIER=n/CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y/' .config
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=n/CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y/' .config
        sed -i 's/CONFIG_FIRMWARE_INCLUDE_JQ=n/CONFIG_FIRMWARE_INCLUDE_JQ=y/' .config

    # ========== 编译固件 ==========
    - name: Build firmware
      run: |
        cd $PADAVAN_DIR/trunk
        make -j$(nproc) all V=s
        
        # 验证输出文件
        find images -name "*.trx" -exec test -f {} \; || (echo "编译失败"; exit 1)
        mkdir -p $GITHUB_WORKSPACE/output
        cp images/*.trx $GITHUB_WORKSPACE/output/

    # ========== 上传产物 ==========
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}_ZT_${{ env.BUILD_TIMESTAMP }}
        path: $GITHUB_WORKSPACE/output/*.trx
