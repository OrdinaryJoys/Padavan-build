name: Padavan-ZeroTier-Build

on:
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  DEVICE: K2P
  BLOCK_SIZE: 15872
  ZT_REPO: https://github.com/zerotier/ZeroTierOne.git

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 120

    steps:
    # ========== 修复分支名称 ==========
    - name: Clone Padavan repository (correct branch)
      uses: actions/checkout@v4
      with:
        repository: hanwckf/padavan-4.4
        path: padavan-src
        ref: main  # 已修正为实际存在的分支
        fetch-depth: 0

    - name: Verify branch existence
      run: |
        cd padavan-src
        git branch -a
        git tag --list

    # ========== 其余步骤保持不变 ==========
    - name: Setup toolchain
      run: |
        cd padavan-src/toolchain-mipsel
        
        # 验证工具链脚本存在性
        [ -f "dl_toolchain.sh" ] || {
          echo "::error::Toolchain script missing"
          exit 1
        }
        
        # 动态架构处理
        case ${{ matrix.target }} in
          mipsel) ARCH="mipsel" ;;
          arm)    ARCH="arm"    ;;
        esac

        # 增强重试逻辑
        for i in {1..5}; do
          echo "Attempt $i/5"
          if ./dl_toolchain.sh $ARCH; then
            [ -d "toolchain-3.4.x/bin" ] && break
          fi
          sleep $((30 + RANDOM % 30))
        done

        [ -d "toolchain-3.4.x/bin" ] || {
          echo "::error::Toolchain setup failed"
          exit 1
        }

    # ... 其他步骤保持原有配置 ...
