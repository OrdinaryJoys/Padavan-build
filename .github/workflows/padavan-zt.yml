name: Padavan-ZeroTier Main Branch Builder

on:
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  DEVICE: K2P  # 修改为你的设备型号
  PADAVAN_REPO: https://github.com/hanwckf/padavan-4.4
  ZEROTIER_REPO: https://github.com/zerotier/ZeroTierOne
  ZEROTIER_BRANCH: main  # 使用 ZeroTier 的 main 分支
  BUILD_TIMESTAMP: $(date -u +"%Y%m%dT%H%M%SZ")

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 180

    steps:
    # ========== 基础环境配置 ==========
    - name: Setup build environment
      run: |
        echo "BUILD_TIMESTAMP=$(date -u +'%Y%m%dT%H%M%SZ')" >> $GITHUB_ENV
        sudo apt-get -qq update
        sudo DEBIAN_FRONTEND=noninteractive apt-get -qq install \
            unzip libtool-bin curl cmake gperf gawk flex bison nano xxd \
            fakeroot kmod cpio git python3-docutils gettext automake autopoint \
            texinfo build-essential help2man pkg-config zlib1g-dev libgmp3-dev \
            libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget jq rsync \
            libssl-dev libjson-c-dev

    # ========== 克隆 Padavan 仓库 ==========
    - name: Clone Padavan repository
      timeout-minutes: 15
      run: |
        # 使用重试机制克隆 Padavan 仓库
        for i in {1..3}; do
          echo "⟳ 克隆 Padavan 仓库 (尝试 $i/3)..."
          git clone --depth=1 --branch=main "$PADAVAN_REPO" padavan-4.4 && break
          sleep 10
          [ $i -eq 3 ] && { echo "::error:: 克隆 Padavan 仓库失败"; exit 1; }
        done

        echo "PADAVAN_DIR=$GITHUB_WORKSPACE/padavan-4.4" >> $GITHUB_ENV

        # 修复子模块
        cd padavan-4.4
        git submodule sync
        git submodule update --init --recursive trunk || {
          echo "::error:: 子模块更新失败"
          exit 1
        }

    # ========== 克隆 ZeroTier 仓库 ==========
    - name: Clone ZeroTier repository
      timeout-minutes: 15
      run: |
        # 使用重试机制克隆 ZeroTier 仓库
        for i in {1..3}; do
          echo "⟳ 克隆 ZeroTier 仓库 (尝试 $i/3)..."
          git clone --depth=1 --branch="$ZEROTIER_BRANCH" "$ZEROTIER_REPO" ZeroTierSource && break
          sleep 10
          [ $i -eq 3 ] && { echo "::error:: 克隆 ZeroTier 仓库失败"; exit 1; }
        done

        # 验证 ZeroTier 目录结构
        [ -d "ZeroTierSource/one" ] || {
          echo "::error:: ZeroTier 目录结构异常"
          ls -l ZeroTierSource
          exit 1
        }

    # ========== 工具链安装 ==========
    - name: Install toolchain
      timeout-minutes: 30
      run: |
        cd $PADAVAN_DIR/toolchain-mipsel

        # 下载工具链（带重试机制）
        for i in {1..3}; do
          echo "⟳ 下载工具链 (尝试 $i/3)..."
          curl -fL --retry 3 --retry-all-errors --retry-delay 5 \
              "https://github.com/hanwckf/padavan-4.4/releases/download/toolchain/toolchain-4.4.x.tar.gz" -o toolchain.tar.gz && break
          sleep 10
          [ $i -eq 3 ] && { echo "::error:: 工具链下载失败"; exit 1; }
        done

        tar -zxvf toolchain.tar.gz
        echo "$PADAVAN_DIR/toolchain-mipsel/toolchain-4.4.x/bin" >> $GITHUB_PATH

    # ========== 集成 ZeroTier ==========
    - name: Integrate ZeroTier
      run: |
        cd $PADAVAN_DIR/trunk
        rm -rf user/zerotier
        mkdir -p user/zerotier

        # 复制 ZeroTier 源码
        rsync -av --info=progress2 "$GITHUB_WORKSPACE/ZeroTierSource/" user/zerotier/ \
            --exclude={.git,.github,doc,artwork,windows}

        # 生成 Makefile
        cat > user/zerotier/Makefile <<'EOF'
        include $(TOPDIR)/rules.mk
        
        PKG_NAME:=zerotier
        PKG_VERSION:=$(shell git -C $(CURDIR) describe --tags 2>/dev/null || echo 1.12.2)
        PKG_RELEASE:=1
        
        include $(INCLUDE_DIR)/package.mk
        
        define Package/zerotier
            SECTION:=net
            CATEGORY:=Network
            TITLE:=ZeroTier One
            URL:=https://www.zerotier.com/
            DEPENDS:=+libpthread +libstdcpp +kmod-tun +libopenssl +libjson-c
        endef
        
        CONFIGURE_ARGS += \
            --host=mipsel-linux-uclibc \
            --enable-static \
            --disable-selinux \
            ZT_ENABLE_NETWORK_CONTROLLER=0
        
        define Build/Compile
            $(MAKE) -C $(PKG_BUILD_DIR)/one \
                CC="$(TARGET_CC)" \
                CXX="(TARGET_CXX)" \
                STRIP="$(TARGET_STRIP)"
        endef
        
        define Package/zerotier/install
            $(INSTALL_DIR) $(1)/usr/bin
            $(INSTALL_BIN) $(PKG_BUILD_DIR)/one/zerotier-one $(1)/usr/bin/
            ln -sf zerotier-one $(1)/usr/bin/zerotier-cli
            $(INSTALL_DIR) $(1)/etc/init.d
            $(INSTALL_BIN) ./scripts/zerotier.init $(1)/etc/init.d/zerotier
        endef
        
        $(eval $(call BuildPackage,zerotier))
        EOF

    # ========== 配置和编译 ==========
    - name: Configure and build
      timeout-minutes: 150
      run: |
        cd $PADAVAN_DIR/trunk

        # 生成默认配置
        ./clear_tree
        yes "" | make oldconfig
        echo "CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y" >> .config

        # 编译固件
        fakeroot ./build_firmware_modify "$DEVICE" || {
          echo "::error:: 编译失败，最后10条错误："
          tail -n 10 build.log
          exit 1
        }

    # ========== 上传产物 ==========
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}_ZT_MAIN_${{ env.BUILD_TIMESTAMP }}
        path: ${{ env.PADAVAN_DIR }}/trunk/images/*.trx
        retention-days: 7
