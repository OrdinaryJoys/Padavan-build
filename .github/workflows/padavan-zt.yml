name: Padavan-ZeroTier AutoBuilder

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      DEVICE: K2P
      BUILD_TIMESTAMP: $(date +%Y%m%d-%H%M%S)
      PADAVAN_REPO: https://github.com/hanwckf/padavan-4.4
      ZEROTIER_REPO: https://github.com/zerotier/ZeroTierOne

    steps:
    # ========== 初始化环境 ==========
    - name: Setup environment
      run: |
        echo "BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "WORKSPACE=$GITHUB_WORKSPACE" >> $GITHUB_ENV

    # ========== 检出主仓库 ==========
    - name: Checkout main repo
      uses: actions/checkout@v4
      with:
        path: main-repo

    # ========== 克隆依赖仓库 ==========
    - name: Clone Padavan
      run: |
        git clone --depth=1 $PADAVAN_REPO
        echo "PADAVAN_DIR=$GITHUB_WORKSPACE/padavan-4.4" >> $GITHUB_ENV

    - name: Clone ZeroTier
      run: |
        git clone --depth=1 $ZEROTIER_REPO
        echo "ZEROTIER_SRC=$GITHUB_WORKSPACE/ZeroTierOne" >> $GITHUB_ENV

    # ========== 验证目录结构 ==========
    - name: Validate structure
      run: |
        echo "工作区结构验证:"
        ls -l
        
        # 核心目录检查
        [ -d "main-repo/zt-ui" ] || { echo "❌ 缺失zt-ui目录"; exit 1; }
        [ -f "main-repo/zt-ui/zerotier.asp" ] || { echo "❌ 缺失ASP文件"; exit 1; }
        [ -d "padavan-4.4/trunk" ] || { echo "❌ Padavan结构异常"; exit 1; }
        [ -d "ZeroTierOne/src" ] || { echo "❌ ZeroTier结构异常"; exit 1; }

    # ========== 安装依赖 ==========
    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          build-essential libncurses5-dev cmake flex bison gperf \
          libssl-dev libjson-c-dev zlib1g-dev python3-pip \
          fakeroot kmod cpio git python3-docutils gettext automake

    # ========== 准备工具链 ==========
    - name: Setup toolchain
      run: |
        cd padavan-4.4/toolchain-mipsel
        ./dl_toolchain.sh
        echo "$GITHUB_WORKSPACE/padavan-4.4/toolchain-mipsel/toolchain-4.4.x/bin" >> $GITHUB_PATH

    # ========== 集成ZeroTier ==========
    - name: Integrate ZeroTier
      run: |
        cd padavan-4.4/trunk
        
        # 复制ZeroTier源码
        mkdir -p user/zerotier
        cp -r $ZEROTIER_SRC/* user/zerotier/
        
        # 创建Makefile
        cat > user/zerotier/Makefile <<'EOF'
        include $(TOPDIR)/rules.mk
        PKG_NAME:=zerotier
        PKG_VERSION:=$(shell git -C $(CURDIR) describe --tags)
        
        include $(INCLUDE_DIR)/package.mk
        
        define Package/zerotier
          SECTION:=net
          CATEGORY:=Network
          TITLE:=ZeroTier One
          DEPENDS:=+libpthread +libstdcpp +kmod-tun +libopenssl +libjson-c
        endef
        
        CONFIGURE_ARGS += \
          --host=mipsel-linux-uclibc \
          --enable-static \
          --disable-selinux \
          ZT_ENABLE_NETWORK_CONTROLLER=0
        
        define Build/Compile
          $(MAKE) -C $(PKG_BUILD_DIR)/one \
            CC="$(TARGET_CC)" \
            CXX="$(TARGET_CXX)" \
            STRIP="$(TARGET_STRIP)"
        endef
        
        define Package/zerotier/install
          $(INSTALL_DIR) $(1)/usr/bin
          $(INSTALL_BIN) $(PKG_BUILD_DIR)/one/zerotier-one $(1)/usr/bin/
          ln -sf zerotier-one $(1)/usr/bin/zerotier-cli
        endef
        
        $(eval $(call BuildPackage,zerotier))
        EOF

    # ========== 集成Web界面 ==========
    - name: Deploy WebUI
      run: |
        cd padavan-4.4/trunk
        mkdir -p user/www/n56u_ribbon_fixed/zerotier
        mkdir -p user/www/cgi-bin
        
        # 复制Web文件
        cp $GITHUB_WORKSPACE/main-repo/zt-ui/*.asp user/www/n56u_ribbon_fixed/
        cp $GITHUB_WORKSPACE/main-repo/zt-ui/*.css user/www/n56u_ribbon_fixed/zerotier/
        cp $GITHUB_WORKSPACE/main-repo/zt-ui/*.cgi user/www/cgi-bin/
        chmod +x user/www/cgi-bin/zerotier_*.cgi
        
        # 注册菜单项
        sed -i '/menuinfo\.push(/a\  menuinfo.push(["zerotier.asp", "ZeroTier"]);' user/www/n56u_ribbon_fixed/state.js

    # ========== 构建配置 ==========
    - name: Configure build
      run: |
        cd padavan-4.4/trunk
        make $DEVICE\_defconfig
        ./scripts/config --set-val CONFIG_FIRMWARE_INCLUDE_ZEROTIER y
        ./scripts/config --set-val CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE y
        ./scripts/config --set-val CONFIG_FIRMWARE_INCLUDE_JQ y
        make oldconfig

    # ========== 编译固件 ==========
    - name: Build firmware
      run: |
        cd padavan-4.4/trunk
        make -j$(nproc) all V=s
        mkdir -p $GITHUB_WORKSPACE/output
        cp images/*.trx $GITHUB_WORKSPACE/output/

    # ========== 发布产物 ==========
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ env.DEVICE }}_ZT_${{ env.BUILD_TIMESTAMP }}
        path: $GITHUB_WORKSPACE/output/*.trx
        retention-days: 7
