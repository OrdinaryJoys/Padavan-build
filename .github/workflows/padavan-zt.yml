name: Padavan-ZeroTier-Build

on:
  workflow_dispatch:
  push:
    tags: ['v*']

env:
  DEVICE: K2P
  BLOCK_SIZE: 15872
  ZT_REPO: https://github.com/zerotier/ZeroTierOne.git
  GIT_TRACE: 1  # 启用Git调试日志

jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45

    steps:
    # ========== 仓库克隆 ==========
    - name: Clone Padavan base (with retry)
      uses: actions/checkout@v4
      with:
        repository: hanwckf/padavan-4.4
        path: padavan
        ref: main  # 确认分支名称
        fetch-depth: 0  # 完整克隆
        retries: 3
        retry-wait-time: 30

    - name: Checkout current repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    # ========== 环境准备 ==========
    - name: Set build timestamp
      id: timestamp
      run: echo "BUILD_TIMESTAMP=$(date +%Y%m%d-%H%M%S)" >> $GITHUB_OUTPUT

    - name: Install dependencies
      run: |
        sudo apt-get update -y
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
          unzip libtool-bin curl cmake gperf gawk flex bison \
          fakeroot kmod cpio git python3-docutils gettext automake \
          texinfo build-essential help2man pkg-config zlib1g-dev libgmp3-dev \
          libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev libssl-dev \
          libjson-c-dev jq upx libatomic1

    # ========== ZeroTier源码 ==========
    - name: Prepare ZeroTier source
      run: |
        for i in {1..3}; do
          git clone --depth 1 --branch $(curl -s https://api.github.com/repos/zerotier/ZeroTierOne/releases/latest | jq -r .tag_name) \
            $ZT_REPO zerotier-src && break || sleep 30
        done
        [ -d "zerotier-src" ] || { echo "::error::ZeroTier clone failed"; exit 1; }
        echo "ZT_VERSION=$(cd zerotier-src && git describe --tags)" >> $GITHUB_ENV

    # ========== 工具链管理 ==========
    - name: Cache toolchain
      uses: actions/cache@v3
      id: toolchain-cache
      with:
        path: padavan/toolchain/toolchain-4.4.x
        key: padavan-toolchain-${{ hashFiles('**/make-linux.mk') }}

    - name: Setup toolchain
      if: steps.toolchain-cache.outputs.cache-hit != 'true'
      run: |
        cd padavan/toolchain
        chmod +x scripts/dl_toolchain.sh
        
        # 增强下载重试逻辑
        for i in {1..5}; do
          echo "Toolchain download attempt $i/5"
          if ./scripts/dl_toolchain.sh mipsel 2>&1 | tee toolchain_$i.log; then
            [ -d "toolchain-4.4.x/bin" ] && break
          fi
          sleep $((30 + RANDOM % 30))  # 随机等待防止请求风暴
        done

        if [ ! -d "toolchain-4.4.x/bin" ]; then
          echo "::error::All toolchain download attempts failed!"
          echo "=== Error Logs ==="
          cat toolchain_*.log
          exit 1
        fi
        echo "TOOLCHAIN_PATH=$(pwd)/toolchain-4.4.x/bin" >> $GITHUB_ENV

    # ========== 固件集成 ==========
    - name: Integrate ZeroTier
      run: |
        mkdir -p padavan/trunk/user/zerotier
        cp -rv zerotier-src/* padavan/trunk/user/zerotier/
        
        cd padavan/trunk
        sed -i '/CFLAGS += -Os/s/$/ -Wno-error=format-truncation/' user/zerotier/Makefile
        echo "LIBS += -ljson-c -latomic" >> user/zerotier/Makefile
        
        cat << EOF >> .config
        CONFIG_FIRMWARE_INCLUDE_ZEROTIER=y
        CONFIG_FIRMWARE_INCLUDE_ZEROTIER_UI=y
        CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE=y
        EOF

    # ========== 固件编译 ==========
    - name: Build firmware
      run: |
        cd padavan/trunk
        ./clear_tree
        
        export PATH="$TOOLCHAIN_PATH:$PATH"
        export CC=mipsel-linux-uclibc-gcc
        export STRIP=mipsel-linux-uclibc-strip
        
        timeout 25m fakeroot ./build_firmware_modify $DEVICE $BLOCK_SIZE 2>&1 | tee build.log || {
          echo "::warning::Build timeout detected"
          exit 1
        }
        
        if [ ! -f "images/$DEVICE.trx" ]; then
          echo "::error::Firmware build failed"
          echo "=== Last 100 lines of build log ==="
          tail -100 build.log
          exit 1
        fi

    # ========== 制品处理 ==========
    - name: Package artifacts
      run: |
        cd padavan/trunk/images
        upx --best --lzma $DEVICE.trx
        
        md5sum $DEVICE.trx > checksum.md5
        sha256sum $DEVICE.trx > checksum.sha256
        
        tar czvf $DEVICE-zt-${{ env.ZT_VERSION }}.tar.gz \
          $DEVICE.trx \
          checksum.md5 \
          checksum.sha256

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: $DEVICE-ZeroTier-${{ env.ZT_VERSION }}
        path: padavan/trunk/images/*.tar.gz
